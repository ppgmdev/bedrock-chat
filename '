package bedrock

import (
	"context"
	"fmt"
    "github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/service/bedrockruntime"
	bedrocktypes "github.com/aws/aws-sdk-go-v2/service/bedrockruntime/types"
)

type BedrockConverse struct {
    Message string
    Model string
    messages []bedrocktypes.Message
}

func (b *BedrockConverse) NewMessage() (string, error) {
    // TODO call bedrock with converse API

    sdkconfig := config

    client := bedrockruntime.NewFromConfig(sdkconfig)
    ctx := context.Background()

    userMessage := bedrocktypes.Message{
        Content: []bedrocktypes.ContentBlock{
            &bedrocktypes.ContentBlockMemberText{
                Value: b.Message,
            },
        },
        Role: bedrocktypes.ConversationRoleUser,
    }

    messages := []bedrocktypes.Message{}
    messages = append(messages, userMessage)

    converseInput := bedrockruntime.ConverseInput{
        ModelId: &b.Model,
        Messages: messages,
    }

    bedrockOutput, err := client.Converse(ctx, &converseInput)

    if err != nil {
        return "", err
    }

    response := bedrockOutput.Output.(*bedrocktypes.ConverseOutputMemberMessage)
    bedrockMessage := response.Value.Content[0].(*bedrocktypes.ContentBlockMemberText)


    fmt.Println(bedrockMessage.Value)

    return bedrockMessage.Value, nil
}
